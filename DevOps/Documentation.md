# 0. Инструкция по использованию:

Для запуска API:

1. Использовать команду: docker-compose up -d

2. Перейти по http://<ваш_IPv4>:7777 

Флаг "-d" нужен, чтобы запустить контейнер в фоновом режиме.

Если будете использовать локально, то не забывайте удалять контейнер и образ, чтобы потом собрался новый.

---
# 1. Создание веб-приложения:

API было создано на основе уже готового проекта, который должен был рисовать магический квадрат от 3x3 до 10x10, также должны были присутствовать анимации. Сам проект состоял из 3 файлов: index.html, style.css и script.js

Я же сделал всё так, чтобы API работало на модуле Python Flask и выбрал порт 7777 (мог какой-нибудь другой).

В итоге есть сайт, где при нажатии на кнопки "3x3", ..., "10x10" генерируются магические квадраты соответствующих размеров, также есть поле для ввода и кнопка "Hello!". При заполении поля и нажатии кнопки "Hello!" в footer появится плавающая надпись "Hello *!", где вместо * будет имя, которое вы ввели.

Само API состоит из 4 частей: index.py, index.html, style.css и script.js

---
# 2. Создание Docker-контейнера:

Будет проще дать комментарии к каждой строке моего короткого Dockerfile:

    FROM python                   #Устанавливается базовый образ для сборки Docker-образа (так как я не указал версию, установится самая последняя, что есть на DockerHub)
    RUN pip install Flask         #Устанавливается нужный мне пакет при помощи pip install
    WORKDIR /root                 #Указываем папку, в которой будем выполнять все действия
    COPY ./app /root              #Копирует папку из одного места в другую (за . принимается место, в котором сейчас находится Dockerfile)
    EXPOSE 7777                   #Указывается порт, на котором будет прослушиваться контейнер (это просто указатель, даже если бы я написал 8888, то контейнер работал бы на 7777, так как я указал это в моём index.py)
    CMD ["python", "index.py"]    #Запускается Python с указанием файла index.py, который должен находиться в рабочей директории /root (папку указали выше)

По итогу создаётся образ с питоном, ставятся необходимые пакеты, указывается рабочая папка, в неё копируется папка с API, запускается API.

---
# 3. Настройка Ansible:

Плейбук можно посмотреть в файле deploy.yml

Кратко о то, что он делает:

1. Устанавливаем необходимые зависимости (если уже установлены и нет новых версий, то ничего меняться не будет) идемпотентность +

2. Устанавливает докер (если уже установлен и нет новых версий, то ничего меняться не будет) идемпотентность +

3. Создаётся папка для docker-compose.yml (если папка уже создана, то ничего меняться не будет) идемпотентность +

4. Копируется docker-compose.yml (если файл не поменялся, то ничего меняться не будет) идемпотентность +

5. Обновляется Docker-образ (чтобы API обновлялось придётся каждый раз Обновлять Docker-образ) идемпотентность -, практичность +

---
# 4. Настройка GitHub Actions:

1. Добавление secrets:

    DOCKER_USERNAME - логин для DockerHub

    DOCKER_PASSWORD - пароль для DockerHub

    REMOTE_HOST - адрес удалённого хоста (AWS)
    
    SSH_PRIVATE_KEY - ssh-ключ для подключения к удалённому хосту

    ANSIBLE_SSH_USER - пользователь, под которым будет работать Ansible

2. Краткий разбор самого workflow:

    2.1. Копирование репозитория на раннер

    2.2. Настройка инструментов для работы с Docker

    2.3. Авторизация в DockerHub

    2.4. Сборка и загрузка образа на DockerHub

    2.5. Деплой проекта на удалённый хост (AWS) при помощи ansible

---
# 5. docker-compose.yml:

    services:                                   # Сервис с именем api
      api:
        restart: always                         # Перезапуск контейнера, если тот внезапно отключится (обеспечивает отказоустойчивость)
        image: mikhailomk/my-flask-app:latest   # Загрузка образа
        container_name: my_app                  # Создание контейнера
        ports:                                  # Указание портов для_браузера:для_контейнера (первое значение можно поменять, если хотите, чтобы страница открывалась на другом порту)
          - 7777:7777
